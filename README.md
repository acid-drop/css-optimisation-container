# CSS Optimisation Container

The CSS Optimisation container is a self-contained optimisation container that
will process files generated by [WP Rocket](https://wp-rocket.me/) and optimise them
for page speed. 

Here are some of the features it includes:

- Docker container installs and configures the complete setup
- Optimises the CSS files with purgecss
- Uses [Puppeteer](https://github.com/puppeteer/puppeteer) to ensure CSS loaded by JavaScipt included
- Adds in contain-intrinsic-size CSS values for optimised page rendering 
- Contains a cron system within the Docker container to ensure always running

## Setup

### Docker

First install docker as per instructions on the docker website. For Ubuntu, these instructions can
be used: https://docs.docker.com/engine/install/ubuntu/

### The Container

To install the container, rename the .env.example file to .env  and edit it the `.env` file to include the correct hostname, domain, realtive rocket_cache_path, relative wordpress_path and to turn log writing on or off. Then, from within the repo directory, run the following:

```
sudo docker build -t dh-puppet .
sudo docker run -v path_to_document_root:/mnt/cache dh-puppet ./run-crond.sh
```

Switch path_to_document_root with your absolute file path to the WordPress directory which is a parent of both the rocket_cache_path and the wordpress_path. 

The first command will build the container. The second command will run the container, linking the local directory to the `/mnt/cache` directory on the container. 

## Commands

To connect to the container once it is running you can use the following command:

```
sudo docker exec -it $(sudo docker ps -a -q -f status=running) /bin/sh
```

To get the UTC time the optimisation was last run you can use the following command:

```
sudo docker exec $(sudo docker ps -a -q -f status=running) stat -c %y /mnt/cache/wp-content/cache/wp-rocket/statusfile.txt
```

To run the container with an interactive prompt:
```
sudo docker run -it -v path_to_document_root:/mnt/cache dh-puppet
```
